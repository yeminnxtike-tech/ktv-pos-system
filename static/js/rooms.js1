// Rooms Page JavaScript - Fixed version with API integration
document.addEventListener('DOMContentLoaded', function() {
    console.log('Rooms.js loaded - Fixed version');
    
    // State variables
    let currentSelectedRoom = null;
    let allRooms = [];
    
    // DOM Elements
    const roomsGrid = document.getElementById('rooms-grid');
    const newOrderBtn = document.getElementById('new-order');
    const addRoomBtn = document.getElementById('add-room');
    const searchBtn = document.getElementById('search-btn');
    
    // Stats elements
    const totalRoomsElement = document.getElementById('total-rooms');
    const availableRoomsElement = document.getElementById('available-rooms');
    const occupiedRoomsElement = document.getElementById('occupied-rooms');
    const avgRoomPriceElement = document.getElementById('avg-room-price');
    
    // Filter buttons
    const filterButtons = document.querySelectorAll('.filter-btn');
    const roomSearchInput = document.getElementById('room-search');
    
    // Initialize
    initializeRoomsApp();
    
    async function initializeRoomsApp() {
        try {
            await loadRoomsFromAPI();
            setupEventListeners();
            updateStats();
            updateDateTime();
        } catch (error) {
            console.error('Error initializing rooms app:', error);
            showNotification('စနစ်စတင်ရာတွင် အမှားဖြစ်ခဲ့သည်', 'error');
        }
    }
    
    function setupEventListeners() {
        // New order button
        if (newOrderBtn) {
            newOrderBtn.addEventListener('click', () => {
                if (confirm('လက်ရှိ အမှာစာကို ဖျက်ပြီး အသစ်စတင်မည်မှာ သေချာပါသလား?')) {
                    clearCurrentOrder();
                    window.location.href = '/sale';
                }
            });
        }
        
        // Add room button
        if (addRoomBtn) {
            addRoomBtn.addEventListener('click', () => openRoomEditModal());
        }
        
        // Search button
        if (searchBtn) {
            searchBtn.addEventListener('click', searchRooms);
        }
        
        // Filter buttons
        filterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                filterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const type = this.getAttribute('data-type');
                filterRooms(type);
            });
        });
        
        // Search input - real-time search
        if (roomSearchInput) {
            roomSearchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                if (searchTerm.length === 0 || searchTerm.length >= 2) {
                    searchRooms();
                }
            });
            
            roomSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchRooms();
                }
            });
        }
        
        // Modal event listeners
        document.getElementById('save-room')?.addEventListener('click', saveRoom);
        document.getElementById('cancel-room')?.addEventListener('click', () => closeModal(document.getElementById('room-edit-modal')));
        document.getElementById('confirm-delete')?.addEventListener('click', confirmDeleteRoom);
        document.getElementById('cancel-delete')?.addEventListener('click', () => closeModal(document.getElementById('delete-room-modal')));
        document.getElementById('close-view')?.addEventListener('click', () => closeModal(document.getElementById('room-view-modal')));
        document.getElementById('use-this-room')?.addEventListener('click', useSelectedRoom);
        
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                closeModal(modal);
            });
        });
        
        // Modal close when clicking outside
        window.addEventListener('click', (e) => {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (e.target === modal) {
                    closeModal(modal);
                }
            });
        });
    }
    
    async function loadRoomsFromAPI() {
        try {
            const response = await fetch('/api/rooms');
            if (!response.ok) {
                throw new Error('Failed to load rooms');
            }
            
            const data = await response.json();
            allRooms = data.rooms || [];
            
            displayRooms(allRooms);
            console.log(`Loaded ${allRooms.length} rooms from API`);
            
        } catch (error) {
            console.error('Error loading rooms from API:', error);
            showNotification('အခန်းများရယူရာတွင် အမှားဖြစ်ခဲ့သည်', 'error');
            allRooms = [];
        }
    }
    
    function updateStats() {
        if (!allRooms || !Array.isArray(allRooms)) return;
        
        const totalRooms = allRooms.length;
        const availableRooms = allRooms.filter(room => room.status === 'available').length;
        const occupiedRooms = allRooms.filter(room => room.status === 'occupied').length;
        
        // Calculate average room price
        const totalPrice = allRooms.reduce((sum, room) => sum + (room.hourly_rate || 0), 0);
        const avgPrice = totalRooms > 0 ? Math.round(totalPrice / totalRooms) : 0;
        
        if (totalRoomsElement) totalRoomsElement.textContent = totalRooms;
        if (availableRoomsElement) availableRoomsElement.textContent = availableRooms;
        if (occupiedRoomsElement) occupiedRoomsElement.textContent = occupiedRooms;
        if (avgRoomPriceElement) avgRoomPriceElement.textContent = avgPrice.toLocaleString() + ' ကျပ်';
    }
    
    function displayRooms(rooms) {
        if (!roomsGrid) return;
        
        roomsGrid.innerHTML = '';
        
        if (!rooms || rooms.length === 0) {
            roomsGrid.innerHTML = `
                <div class="no-rooms-message">
                    <i class="fas fa-door-closed fa-3x"></i>
                    <p>အခန်းများ မရှိသေးပါ</p>
                    <p>ကျေးဇူးပြု၍ အခန်းအသစ်ထည့်သွင်းပါ</p>
                </div>
            `;
            return;
        }
        
        rooms.forEach(room => {
            const roomElement = createRoomElement(room);
            roomsGrid.appendChild(roomElement);
        });
    }
    
    function createRoomElement(room) {
        const roomElement = document.createElement('div');
        
        // Set room card class based on status
        let roomClass = `room-card ${room.status === 'occupied' ? 'occupied' : 'available'}`;
        
        roomElement.className = roomClass;
        roomElement.dataset.id = room.id;
        roomElement.dataset.name = room.room_name;
        roomElement.dataset.type = room.room_type;
        roomElement.dataset.capacity = room.capacity;
        roomElement.dataset.price = room.hourly_rate;
        roomElement.dataset.status = room.status;
        
        // Status badge
        let statusText = '';
        let statusClass = '';
        
        switch(room.status) {
            case 'available':
                statusText = 'လစ်လပ်ပါသည်';
                statusClass = 'available-badge';
                break;
            case 'occupied':
                statusText = 'ရှိပါသည်';
                statusClass = 'occupied-badge';
                break;
            case 'reserved':
                statusText = 'ကြိုတင်ယူထား';
                statusClass = 'reserved-badge';
                break;
            case 'cleaning':
                statusText = 'ပြင်ဆင်နေဆဲ';
                statusClass = 'cleaning-badge';
                break;
            default:
                statusText = room.status;
                statusClass = 'available-badge';
        }
        
        // Room type display
        let typeDisplay = '';
        let typeIcon = '';
        
        switch(room.room_type) {
            case 'vip':
                typeDisplay = 'VIP';
                typeIcon = 'fa-crown';
                break;
            case 'standard':
                typeDisplay = 'Standard';
                typeIcon = 'fa-home';
                break;
            case 'family':
                typeDisplay = 'Family';
                typeIcon = 'fa-users';
                break;
            default:
                typeDisplay = room.room_type;
                typeIcon = 'fa-door-closed';
        }
        
        roomElement.innerHTML = `
            <div class="room-header">
                <div class="room-name">${room.room_name || room.room_number}</div>
                <div class="room-status-badge ${statusClass}">${statusText}</div>
            </div>
            <div class="room-type">
                <i class="fas ${typeIcon}"></i>
                ${typeDisplay}
            </div>
            <div class="room-details">
                <div class="detail-item">
                    <i class="fas fa-users"></i>
                    <span>လူဦးရေ: ${room.capacity || 4}</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>${(room.hourly_rate || 0).toLocaleString()} ကျပ်</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-hashtag"></i>
                    <span>အမှတ်: ${room.room_number}</span>
                </div>
            </div>
            <div class="room-actions">
                <button class="btn-action view-btn" data-room-id="${room.id}" title="အခန်းကြည့်မည်">
                    <i class="fas fa-eye"></i> View
                </button>
                <button class="btn-action edit-btn" data-room-id="${room.id}" title="အခန်းပြင်မည်">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn-action delete-btn" data-room-id="${room.id}" title="အခန်းဖျက်မည်">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn-action use-btn" data-room-id="${room.id}" title="ဤအခန်းကို သုံးမည်">
                    <i class="fas fa-shopping-cart"></i> Use
                </button>
            </div>
        `;
        
        // Add event listeners to action buttons
        setupRoomActionButtons(roomElement, room);
        
        return roomElement;
    }
    
    function setupRoomActionButtons(roomElement, room) {
        // View button
        roomElement.querySelector('.view-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            viewRoom(room);
        });
        
        // Edit button
        roomElement.querySelector('.edit-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            editRoom(room);
        });
        
        // Delete button
        roomElement.querySelector('.delete-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            deleteRoom(room);
        });
        
        // Use button - FIXED: Directly redirect to sale page with room_id
        roomElement.querySelector('.use-btn').addEventListener('click', async (e) => {
            e.stopPropagation();
            await useRoom(room);
        });
        
        // Room card click - also goes to sale
        roomElement.addEventListener('click', () => {
            useRoom(room);
        });
    }
    
    async function viewRoom(room) {
        console.log('View room:', room);
        currentSelectedRoom = room;
        
        // Update modal with room details
        document.getElementById('view-room-name').textContent = room.room_name || room.room_number || '-';
        
        // Room type
        let typeDisplay = '';
        switch(room.room_type) {
            case 'vip': typeDisplay = 'VIP'; break;
            case 'standard': typeDisplay = 'Standard'; break;
            case 'family': typeDisplay = 'Family'; break;
            default: typeDisplay = room.room_type || '-';
        }
        document.getElementById('view-room-type').textContent = typeDisplay;
        
        document.getElementById('view-room-capacity').textContent = room.capacity || '0';
        document.getElementById('view-room-price').textContent = room.hourly_rate ? room.hourly_rate.toLocaleString() + ' ကျပ်' : '-';
        
        // Status
        let statusDisplay = '';
        switch(room.status) {
            case 'available': statusDisplay = 'လစ်လပ်ပါသည်'; break;
            case 'occupied': statusDisplay = 'ရှိပါသည်'; break;
            case 'reserved': statusDisplay = 'ကြိုတင်ယူထား'; break;
            case 'cleaning': statusDisplay = 'ပြင်ဆင်နေဆဲ'; break;
            default: statusDisplay = room.status || '-';
        }
        document.getElementById('view-room-status').textContent = statusDisplay;
        
        document.getElementById('view-room-created').textContent = room.created_at || '-';
        document.getElementById('view-room-description').textContent = room.notes || 'အချက်အလက်မရှိပါ';
        
        // Open view modal
        openModal(document.getElementById('room-view-modal'));
    }
    
    function editRoom(room) {
        console.log('Edit room:', room);
        currentSelectedRoom = room;
        
        // Fill form with room data
        document.getElementById('room-id').value = room.id || '';
        document.getElementById('room-name').value = room.room_name || '';
        
        // Room type mapping
        let typeValue = '';
        switch(room.room_type) {
            case 'vip': typeValue = 'VIP'; break;
            case 'standard': typeValue = 'Standard'; break;
            case 'family': typeValue = 'Family'; break;
            default: typeValue = room.room_type || '';
        }
        
        document.getElementById('room-type').value = typeValue;
        document.getElementById('room-capacity').value = room.capacity || 4;
        document.getElementById('room-price').value = room.hourly_rate || 30000;
        
        // Status mapping
        let statusValue = '';
        switch(room.status) {
            case 'available': statusValue = 'လစ်လပ်ပါသည်'; break;
            case 'occupied': statusValue = 'ရှိပါသည်'; break;
            case 'reserved': statusValue = 'ကြိုတင်ယူထား'; break;
            case 'cleaning': statusValue = 'ပြင်ဆင်နေဆဲ'; break;
            default: statusValue = room.status || 'လစ်လပ်ပါသည်';
        }
        
        document.getElementById('room-status').value = statusValue;
        document.getElementById('room-description-input').value = room.notes || '';
        
        // Update modal title
        document.getElementById('room-modal-title').textContent = room.id ? 'အခန်းပြင်ဆင်ခြင်း' : 'အခန်းအသစ်ထည့်သွင်းခြင်း';
        
        // Open edit modal
        openModal(document.getElementById('room-edit-modal'));
    }
    
    function deleteRoom(room) {
        console.log('Delete room:', room);
        currentSelectedRoom = room;
        
        // Set confirmation message
        const message = `"${room.room_name || room.room_number}" အခန်းကို ဖျက်ရန် သေချာပါသလား?`;
        document.getElementById('delete-room-message').textContent = message;
        
        // Open delete modal
        openModal(document.getElementById('delete-room-modal'));
    }
    
    async function useRoom(room) {
        console.log('Use room:', room);
        
        try {
            // FIXED: Use traditional form submission instead of API
            // Clear any existing session
            localStorage.removeItem('ktv_active_room_id');
            
            // Show notification
            showNotification(`"${room.room_name || room.room_number}" အခန်းကို အသုံးပြုမည်...`, 'success');
            
            // Redirect to sale page with room_id parameter
            // Use traditional redirect instead of API
            window.location.href = `/room/${room.id}/select`;
            
        } catch (error) {
            console.error('Error selecting room:', error);
            showNotification('အခန်းရွေးချယ်ရာတွင် အမှားဖြစ်ခဲ့သည်', 'error');
        }
    }
    
    function searchRooms() {
        const searchTerm = roomSearchInput.value.trim().toLowerCase();
        
        if (!searchTerm) {
            displayRooms(allRooms);
            return;
        }
        
        const filteredRooms = allRooms.filter(room => {
            return (
                (room.room_name && room.room_name.toLowerCase().includes(searchTerm)) ||
                (room.room_number && room.room_number.toLowerCase().includes(searchTerm)) ||
                (room.notes && room.notes.toLowerCase().includes(searchTerm))
            );
        });
        
        displayRooms(filteredRooms);
    }
    
    function filterRooms(type) {
        let filteredRooms = [];
        
        switch(type) {
            case 'all':
                filteredRooms = allRooms;
                break;
            case 'VIP':
                filteredRooms = allRooms.filter(room => room.room_type === 'vip');
                break;
            case 'Standard':
                filteredRooms = allRooms.filter(room => room.room_type === 'standard');
                break;
            case 'Family':
                filteredRooms = allRooms.filter(room => room.room_type === 'family');
                break;
            case 'occupied':
                filteredRooms = allRooms.filter(room => room.status === 'occupied');
                break;
            case 'available':
                filteredRooms = allRooms.filter(room => room.status === 'available');
                break;
            default:
                filteredRooms = allRooms;
        }
        
        displayRooms(filteredRooms);
    }
    
    async function saveRoom() {
    // Get form data
    const roomId = document.getElementById('room-id').value;
    const roomName = document.getElementById('room-name').value.trim();
    const roomTypeSelect = document.getElementById('room-type').value;
    const roomCapacity = parseInt(document.getElementById('room-capacity').value);
    const roomPrice = parseFloat(document.getElementById('room-price').value);
    const roomStatusSelect = document.getElementById('room-status').value;
    const roomDescription = document.getElementById('room-description-input').value.trim();
    
    // ADD THIS: Get room number from form
    const roomNumber = document.getElementById('room-number').value.trim();
    
    // Validation
    if (!roomName) {
        showNotification('ကျေးဇူးပြု၍ အခန်းအမည် ထည့်ပါ', 'error');
        return;
    }
    
    // ADD THIS: Validate room number
    if (!roomNumber) {
        showNotification('ကျေးဇူးပြု၍ အခန်းနံပါတ် ထည့်ပါ', 'error');
        return;
    }
    
    if (!roomTypeSelect) {
        showNotification('ကျေးဇူးပြု၍ အခန်းအမျိုးအစား ရွေးပါ', 'error');
        return;
    }
    
    if (isNaN(roomCapacity) || roomCapacity < 1) {
        showNotification('လူဦးရေစွမ်းရည် မှန်ကန်စွာ ထည့်ပါ', 'error');
        return;
    }
    
    if (isNaN(roomPrice) || roomPrice < 0) {
        showNotification('အခန်းခ မှန်ကန်စွာ ထည့်ပါ', 'error');
        return;
    }
    
    // Map values to database format
    const roomType = roomTypeSelect.toLowerCase();
    
    let roomStatus = 'available';
    switch(roomStatusSelect) {
        case 'ရှိပါသည်': roomStatus = 'occupied'; break;
        case 'လစ်လပ်ပါသည်': roomStatus = 'available'; break;
        case 'ကြိုတင်ယူထား': roomStatus = 'reserved'; break;
        case 'ပြင်ဆင်နေဆဲ': roomStatus = 'cleaning'; break;
    }
    
    try {
        const roomData = {
            room_name: roomName,
            room_type: roomType,
            capacity: roomCapacity,
            hourly_rate: roomPrice,
            status: roomStatus,
            notes: roomDescription
        };
        
        let response;
        
        if (roomId) {
            // Update existing room
            roomData.room_id = roomId;
            // ADD THIS: Include room number for update
            roomData.room_number = roomNumber;
            response = await fetch('/api/update_room', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(roomData)
            });
        } else {
            // Add new room
            // CHANGE THIS: Use user-provided room number instead of auto-generated
            roomData.room_number = roomNumber;
            response = await fetch('/api/add_room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(roomData)
            });
        }
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message || 'အခန်းသိမ်းဆည်းပြီးပါပြီ', 'success');
            
            // Reload rooms
            await loadRoomsFromAPI();
            
            // Close modal
            closeModal(document.getElementById('room-edit-modal'));
        } else {
            showNotification(result.error || 'အခန်းသိမ်းဆည်းရာတွင် အမှားဖြစ်ခဲ့သည်', 'error');
        }
        
    } catch (error) {
        console.error('Error saving room:', error);
        showNotification('အခန်းသိမ်းဆည်း�ရာတွင် အမှားဖြစ်ခဲ့သည်', 'error');
    }
}
    
    async function confirmDeleteRoom() {
        if (!currentSelectedRoom) return;
        
        try {
            const response = await fetch(`/api/delete_room/${currentSelectedRoom.id}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification(result.message || 'အခန်းဖျက်ပြီးပါပြီ', 'success');
                
                // Reload rooms
                await loadRoomsFromAPI();
                
                closeModal(document.getElementById('delete-room-modal'));
                currentSelectedRoom = null;
            } else {
                showNotification(result.error || 'အခန်းဖျက်ရာတွင် အမှားဖြစ်ခဲ့သည်', 'error');
            }
            
        } catch (error) {
            console.error('Error deleting room:', error);
            showNotification('အခန်းဖျက်ရာတွင် အမှားဖြစ်ခဲ့သည်', 'error');
        }
    }
    
    function useSelectedRoom() {
        if (currentSelectedRoom) {
            useRoom(currentSelectedRoom);
        }
    }
    
    function clearCurrentOrder() {
        // Clear current order from localStorage
        try {
            localStorage.removeItem('ktv_current_order');
        } catch (error) {
            console.error('Error clearing order:', error);
        }
    }
    
    function openRoomEditModal() {
        // Reset form for new room
        document.getElementById('room-id').value = '';
        document.getElementById('room-name').value = '';
        document.getElementById('room-type').value = '';
        document.getElementById('room-capacity').value = 4;
        document.getElementById('room-price').value = 30000;
        document.getElementById('room-status').value = 'လစ်လပ်ပါသည်';
        document.getElementById('room-description-input').value = '';
        
        // Update modal title
        document.getElementById('room-modal-title').textContent = 'အခန်းအသစ်ထည့်သွင်းခြင်း';
        
        // Open modal
        openModal(document.getElementById('room-edit-modal'));
    }
    
    function openModal(modal) {
        if (modal) {
            modal.style.display = 'block';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
    }
    
    function closeModal(modal) {
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    }
    
    function updateDateTime() {
        const now = new Date();
        const day = now.getDate().toString().padStart(2, '0');
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const year = now.getFullYear();
        const dateStr = `${day}-${month}-${year}`;
        
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timeStr = `${hours}:${minutes}`;
        
        document.getElementById('current-date').textContent = dateStr;
        document.getElementById('current-time').textContent = timeStr;
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        `;
        
        // Add to body
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
});
