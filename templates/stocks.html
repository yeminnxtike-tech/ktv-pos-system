{% extends "base.html" %}

{% block title %}ပစ္စည်း အဝင်/အထွက် - KTV POS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stocks.css') }}">
{% endblock %}

{% block mode %}ပစ္စည်း အဝင်/အထွက်{% endblock %}

{% block content %}
<div class="stocks-page">
    <!-- Stocks Header -->
    <div class="stocks-header">
        <div class="header-left">
            <h2><i class="fas fa-boxes"></i> ပစ္စည်း အဝင်/အထွက် စီမံခန့်ခွဲမှု</h2>
            <p class="subtitle">ပစ္စည်းစာရင်း နှင့် လက်ကျန်ပမာဏများ</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openStockModal()">
                <i class="fas fa-plus"></i> ပစ္စည်းအသစ်ထည့်ရန်
            </button>
            <button class="btn btn-success" onclick="exportStocks()">
                <i class="fas fa-file-export"></i> Excel ထုတ်ရန်
            </button>
            <button class="btn btn-info" onclick="refreshStocks()">
                <i class="fas fa-sync-alt"></i> ပြန်စစ်ရန်
            </button>
        </div>
    </div>

    <!-- Stock Statistics -->
    <div class="stock-stats">
        <div class="stat-item">
            <div class="stat-icon total">
                <i class="fas fa-box"></i>
            </div>
            <div class="stat-info">
                <h3>စုစုပေါင်း ပစ္စည်းများ</h3>
                <div class="stat-value" id="total-items">0</div>
            </div>
        </div>
        
        <div class="stat-item">
            <div class="stat-icon low-stock">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-info">
                <h3>လက်ကျန်နည်းသော ပစ္စည်းများ</h3>
                <div class="stat-value" id="low-stock-items">0</div>
            </div>
        </div>
        
        <div class="stat-item">
            <div class="stat-icon out-of-stock">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-info">
                <h3>ပစ္စည်းကုန်သွားသော</h3>
                <div class="stat-value" id="out-of-stock-items">0</div>
            </div>
        </div>
        
        <div class="stat-item">
            <div class="stat-icon value">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stat-info">
                <h3>စုစုပေါင်းတန်ဖိုး</h3>
                <div class="stat-value" id="total-value">0 Ks</div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filters-section">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="stock-search" placeholder="ပစ္စည်းအမည် ရှာရန်..." onkeyup="searchStocks()">
        </div>
        
        <div class="filter-options">
            <select id="category-filter" onchange="filterStocks()">
                <option value="all">အားလုံး</option>
                <option value="low">လက်ကျန်နည်း</option>
                <option value="out">ပစ္စည်းကုန်</option>
                <option value="active">ရောင်းနိုင်သော</option>
                <option value="inactive">ရောင်းမရ</option>
            </select>
            
            <select id="sort-by" onchange="sortStocks()">
                <option value="name">အမည်အလိုက်</option>
                <option value="stock">လက်ကျန်အလိုက်</option>
                <option value="price">စျေးနှုန်းအလိုက်</option>
            </select>
        </div>
    </div>

    <!-- Stocks Table -->
    <div class="stocks-container">
        <div class="table-responsive">
            <table class="stocks-table" id="stocks-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ပစ္စည်းအမည်</th>
                        <th>အမျိုးအစား</th>
                        <th>ရောင်းစျေးနှုန်း</th>
                        <th>လက်ကျန်</th>
                        <th>တန်ဖိုး</th>
                        <th>အခြေအနေ</th>
                        <th>လုပ်ဆောင်ချက်များ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr data-item-id="{{ item.id }}" 
                        data-stock="{{ item.stock }}" 
                        data-min-stock="{{ item.min_stock }}"
                        data-status="{{ item.status }}">
                        <td>{{ loop.index }}</td>
                        <td class="item-name">{{ item.name }}</td>
                        <td>{{ item.category_display }}</td>
                        <td class="item-price">{{ "{:,}".format(item.sale_price) }} Ks</td>
                        <td>
                            <span class="stock-quantity">{{ item.stock }}</span> {{ item.unit }}
                        </td>
                        <td class="item-value">{{ "{:,}".format(item.sale_price * item.stock) }} Ks</td>
                        <td>
                            {% if item.status == 'inactive' %}
                            <span class="status-badge inactive">ရောင်းမရ</span>
                            {% elif item.stock == 0 %}
                            <span class="status-badge out-of-stock">ပစ္စည်းကုန်</span>
                            {% elif item.stock <= item.min_stock %}
                            <span class="status-badge low-stock">လက်ကျန်နည်း</span>
                            {% else %}
                            <span class="status-badge available">ရောင်းနိုင်</span>
                            {% endif %}
                        </td>
                        <td class="actions">
                            <button class="btn btn-success btn-sm" onclick="addStock({{ item.id }}, '{{ item.name }}')" 
                                    {% if item.status == 'inactive' %}disabled{% endif %}>
                                <i class="fas fa-plus"></i> ထည့်ရန်
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="adjustStock({{ item.id }}, '{{ item.name }}')"
                                    {% if item.status == 'inactive' %}disabled{% endif %}>
                                <i class="fas fa-edit"></i> ပြင်ရန်
                            </button>
                            <button class="btn btn-info btn-sm" onclick="viewHistory({{ item.id }}, '{{ item.name }}')">
                                <i class="fas fa-history"></i> မှတ်တမ်း
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if not items %}
        <div class="empty-state">
            <i class="fas fa-box-open fa-3x"></i>
            <h3>ပစ္စည်းများ မရှိသေးပါ</h3>
            <p>ကျေးဇူးပြု၍ ပစ္စည်းအသစ်ထည့်သွင်းပါ</p>
            <button class="btn btn-primary" onclick="openStockModal()">
                <i class="fas fa-plus"></i> ပစ္စည်းအသစ်ထည့်ရန်
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Stock Modal -->
<div class="modal" id="stock-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-box"></i> <span id="stock-modal-title">ပစ္စည်းအသစ်ထည့်ရန်</span></h3>
            <button class="modal-close" onclick="closeStockModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <form id="stock-form">
                <div class="form-group">
                    <label for="stock-item-name">ပစ္စည်းအမည် *</label>
                    <input type="text" id="stock-item-name" class="form-control" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="stock-category">အမျိုးအစား</label>
                        <select id="stock-category" class="form-control">
                            <option value="beer">Beer</option>
                            <option value="juice">Juice</option>
                            <option value="wine">အရက်</option>
                            <option value="food">အစားအစာ</option>
                            <option value="drink">အချိုရည်</option>
                            <option value="other">အခြား</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="stock-unit">ယူနစ်</label>
                        <select id="stock-unit" class="form-control">
                            <option value="ပုလင်း">ပုလင်း</option>
                            <option value="ခွက်">ခွက်</option>
                            <option value="ခု">ခု</option>
                            <option value="ပွဲ">ပွဲ</option>
                            <option value="ထုပ်">ထုပ်</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="stock-price">ရောင်းစျေးနှုန်း *</label>
                        <input type="number" id="stock-price" class="form-control" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="stock-cost">ဝယ်စျေးနှုန်း</label>
                        <input type="number" id="stock-cost" class="form-control" min="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="initial-stock">ကနဦးလက်ကျန် *</label>
                        <input type="number" id="initial-stock" class="form-control" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="min-stock">အနည်းဆုံးလက်ကျန်</label>
                        <input type="number" id="min-stock" class="form-control" min="0" value="5">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="stock-notes">မှတ်ချက်</label>
                    <textarea id="stock-notes" class="form-control" rows="2"></textarea>
                </div>
            </form>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeStockModal()">မလုပ်တော့ပါ</button>
            <button class="btn btn-primary" onclick="saveStockItem()">သိမ်းဆည်းမည်</button>
        </div>
    </div>
</div>

<!-- Adjust Stock Modal -->
<div class="modal" id="adjust-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> လက်ကျန်ပြင်ဆင်ရန်</h3>
            <button class="modal-close" onclick="closeAdjustModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div id="adjust-item-info"></div>
            
            <div class="current-stock">
                <h4>လက်ရှိလက်ကျန်: <span id="current-stock">0</span></h4>
            </div>
            
            <div class="form-group">
                <label for="adjust-type">လုပ်ဆောင်ချက်</label>
                <select id="adjust-type" class="form-control" onchange="toggleAdjustFields()">
                    <option value="add">ပစ္စည်းထည့်ရန်</option>
                    <option value="adjust">လက်ကျန်ပြင်ရန်</option>
                    <option value="waste">ပစ္စည်းဖျက်ရန်</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="adjust-quantity">ပမာဏ *</label>
                <input type="number" id="adjust-quantity" class="form-control" min="1" value="1" required>
            </div>
            
            <div class="form-group" id="adjust-price-group">
                <label for="adjust-price">တစ်ခုစျေးနှုန်း (Ks)</label>
                <input type="number" id="adjust-price" class="form-control" min="0">
            </div>
            
            <div class="form-group">
                <label for="adjust-reason">အကြောင်းအရင်း</label>
                <textarea id="adjust-reason" class="form-control" rows="2" placeholder="အကြောင်းအရင်း..."></textarea>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAdjustModal()">မလုပ်တော့ပါ</button>
            <button class="btn btn-primary" onclick="saveAdjustment()">အတည်ပြုမည်</button>
        </div>
    </div>
</div>

<!-- Stock History Modal -->
<div class="modal" id="history-modal">
    <div class="modal-content wide-modal">
        <div class="modal-header">
            <h3><i class="fas fa-history"></i> ပစ္စည်းမှတ်တမ်း</h3>
            <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div id="history-item-info"></div>
            
            <div class="history-filters">
                <select id="history-type" onchange="loadHistory()">
                    <option value="all">အားလုံး</option>
                    <option value="purchase">ဝယ်ယူမှု</option>
                    <option value="sale">ရောင်းချမှု</option>
                    <option value="adjustment">ပြင်ဆင်မှု</option>
                    <option value="wastage">ပစ္စည်းဖျက်မှု</option>
                </select>
                
                <input type="date" id="history-date" onchange="loadHistory()">
            </div>
            
            <div class="table-responsive">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>ရက်စွဲ</th>
                            <th>လုပ်ဆောင်ချက်</th>
                            <th>ပမာဏ</th>
                            <th>စျေးနှုန်း</th>
                            <th>စုစုပေါင်း</th>
                            <th>မှတ်ချက်</th>
                            <th>ဝန်ထမ်း</th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody">
                        <!-- History will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeHistoryModal()">ပိတ်မည်</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/stocks.js') }}"></script>
<script>
    // Initialize stock stats
    function updateStockStats() {
        const items = document.querySelectorAll('#stocks-table tbody tr');
        let totalItems = items.length;
        let lowStock = 0;
        let outOfStock = 0;
        let totalValue = 0;
        
        items.forEach(item => {
            const stock = parseInt(item.getAttribute('data-stock')) || 0;
            const minStock = parseInt(item.getAttribute('data-min-stock')) || 5;
            const price = parseInt(item.querySelector('.item-price').textContent.replace(/,/g, '')) || 0;
            const status = item.getAttribute('data-status');
            
            totalValue += stock * price;
            
            if (status !== 'inactive') {
                if (stock === 0) {
                    outOfStock++;
                } else if (stock <= minStock) {
                    lowStock++;
                }
            }
        });
        
        document.getElementById('total-items').textContent = totalItems;
        document.getElementById('low-stock-items').textContent = lowStock;
        document.getElementById('out-of-stock-items').textContent = outOfStock;
        document.getElementById('total-value').textContent = totalValue.toLocaleString() + ' Ks';
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateStockStats();
    });
</script>
{% endblock %}
